
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loading External Data &#8212; NautilusTrader Docs</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/shell.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">NautilusTrader Docs</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../1_getting_started/0_index.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../1_getting_started/1_installation.html">
     Installation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="0_index.html">
   User Guide
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="1_core_concepts.html">
     Core Concepts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="3_backtest_example.html">
     Complete Backtest Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../3_api_reference/0_index.html">
   API Reference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/accounting.html">
     Accounting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/analysis.html">
     Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/backtest.html">
     Backtest
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/cache.html">
     Cache
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/common.html">
     Common
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/core.html">
     Core
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/data.html">
     Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/execution.html">
     Execution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/indicators.html">
     Indicators
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/infrastructure.html">
     Infrastructure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/live.html">
     Live
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../3_api_reference/model/0_index.html">
     Model
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/commands.html">
       Commands
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/currency.html">
       Currency
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/data.html">
       Data
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/events.html">
       Events
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/identifiers.html">
       Identifiers
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/instruments.html">
       Instruments
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/objects.html">
       Objects
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/orderbook.html">
       Order Book
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/orders.html">
       Orders
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/position.html">
       Position
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../3_api_reference/model/tick_scheme.html">
       Tick Scheme
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/msgbus.html">
     Message Bus
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/network.html">
     Network
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/persistence.html">
     Persistence
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/portfolio.html">
     Portfolio
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/risk.html">
     Risk
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/serialization.html">
     Serialization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3_api_reference/trading.html">
     Trading
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../4_integrations/0_index.html">
   Integrations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../4_integrations/betfair.html">
     Betfair
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../4_integrations/binance.html">
     Binance
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../4_integrations/ftx.html">
     FTX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../4_integrations/ib.html">
     Interactive Brokers
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../5_developer_guide/0_index.html">
   Developer Guide
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../5_developer_guide/1_environment_setup.html">
     Environment Setup
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../5_developer_guide/2_coding_standards.html">
     Coding Standards
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../5_developer_guide/3_cython.html">
     Cython
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../5_developer_guide/4_testing.html">
     Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../5_developer_guide/5_packaged_data.html">
     Packaged Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference external" href="https://github.com/nautechsystems/nautilus_trader/blob/develop/CONTRIBUTING.md">
     Contributing
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/2_user_guide/4_loading_external_data.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/nautechsystems/nautilus_trader"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/nautechsystems/nautilus_trader/issues/new?title=Issue%20on%20page%20%2F2_user_guide/4_loading_external_data.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-data-catalog">
   The Data Catalog
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#getting-some-sample-raw-data">
   Getting some sample raw data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-data-via-reader-classes">
     Loading data via
     <code class="docutils literal notranslate">
      <span class="pre">
       Reader
      </span>
     </code>
     classes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#writing-the-parser-function">
     Writing the
     <code class="docutils literal notranslate">
      <span class="pre">
       parser
      </span>
     </code>
     function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-a-datacatalog-if-one-does-not-exist">
     Creating a DataCatalog if one does not exist
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#instruments">
     Instruments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-files">
     Loading the files
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-the-data-catalog">
   Using the Data Catalog
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="loading-external-data">
<h1>Loading External Data<a class="headerlink" href="#loading-external-data" title="Permalink to this headline">¶</a></h1>
<p>This notebook runs through a example loading raw data (external to nautilus) into the Nautilus Trader <code class="docutils literal notranslate"><span class="pre">DataCatalog</span></code>, for use in backtesting.</p>
<div class="section" id="the-data-catalog">
<h2>The Data Catalog<a class="headerlink" href="#the-data-catalog" title="Permalink to this headline">¶</a></h2>
<p>The data catalog is a central store for Nautilus data, persisted in the <a class="reference external" href="https://parquet.apache.org">Parquet</a> file format.</p>
<p>We have chosen parquet as the storage format for the following reasons:</p>
<ul class="simple">
<li><p>It performs much better than CSV/JSON/HDF5/etc in terms of compression (storage size) and read performance.</p></li>
<li><p>It does not require any separate running components (for example a database).</p></li>
<li><p>It is quick and simple for someone to get up and running with.</p></li>
</ul>
<!-- #region tags=[] -->
</div>
<div class="section" id="getting-some-sample-raw-data">
<h2>Getting some sample raw data<a class="headerlink" href="#getting-some-sample-raw-data" title="Permalink to this headline">¶</a></h2>
<p>Before we start the notebook - as a once off we need to download some sample data for loading</p>
<p>For this notebook we will use Forex data from <code class="docutils literal notranslate"><span class="pre">histdata.com</span></code>, simply go to <a class="reference external" href="https://www.histdata.com/download-free-forex-historical-data/?/ascii/tick-data-quotes/">https://www.histdata.com/download-free-forex-historical-data/?/ascii/tick-data-quotes/</a> and select a Forex pair and one or more months of data to download.</p>
<p>Once you have downloaded the data, set the variable <code class="docutils literal notranslate"><span class="pre">input_files</span></code> below to the path containing the data. You can also use a glob to select multiple files, for example <code class="docutils literal notranslate"><span class="pre">&quot;~/Downloads/HISTDATA_COM_ASCII_AUDUSD_*.zip&quot;</span></code></p>
<!-- #endregion -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fsspec</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">filesystem</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>

<span class="n">input_files</span> <span class="o">=</span> <span class="s2">&quot;~/Downloads/HISTDATA_COM_ASCII_AUDUSD_T202001.zip&quot;</span>
</pre></div>
</div>
<p>Run the cell below; you should see the files that you downloaded</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple check that the file path is correct</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_files</span><span class="p">)),</span> <span class="sa">f</span><span class="s2">&quot;Could not find files with </span><span class="si">{</span><span class="n">input_files</span><span class="si">=}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="section" id="loading-data-via-reader-classes">
<h3>Loading data via <code class="docutils literal notranslate"><span class="pre">Reader</span></code> classes<a class="headerlink" href="#loading-data-via-reader-classes" title="Permalink to this headline">¶</a></h3>
<p>We can load data from various sources into the data catalog using helper methods in the <code class="docutils literal notranslate"><span class="pre">nautilus_trader.persistence.external.readers</span></code> module. The module contains methods for reading various data formats (csv, json, txt), minimising the amount of code required to get data loaded correctly into the data catalog.</p>
<p>There are a handful of readers available, some notes on when to use which:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CSVReader</span></code> - use when your data is CSV (comma separated values) and has a header row. Each row of the data typically is one “entry” and is linked to the header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TextReader</span></code> - similar to CSVReader, but used when data may container multiple “entries” per line, for example JSON data with multiple orderbook or trade ticks in a single line. Typically does not have a header row and field names come from some definition elsewhere.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ParquetReader</span></code> - for parquet files, will read chunks of the data and process similar to <code class="docutils literal notranslate"><span class="pre">CSVReader</span></code></p></li>
</ul>
<p>Each of the <code class="docutils literal notranslate"><span class="pre">Reader</span></code> classes takes a <code class="docutils literal notranslate"><span class="pre">line_parser</span></code> or <code class="docutils literal notranslate"><span class="pre">block_parser</span></code> function, a user defined function to convert a line or block (chunk / multiple rows) of data into nautilus object(s) (for example <code class="docutils literal notranslate"><span class="pre">QuoteTick</span></code> or <code class="docutils literal notranslate"><span class="pre">TradeTick</span></code>).</p>
</div>
<div class="section" id="writing-the-parser-function">
<h3>Writing the <code class="docutils literal notranslate"><span class="pre">parser</span></code> function<a class="headerlink" href="#writing-the-parser-function" title="Permalink to this headline">¶</a></h3>
<p>The Forex data from <code class="docutils literal notranslate"><span class="pre">histdata</span></code> is stored in csv/text format, with fields <code class="docutils literal notranslate"><span class="pre">timestamp,</span> <span class="pre">bid_price,</span> <span class="pre">ask_price</span></code>.</p>
<p>For this example, we will use the <code class="docutils literal notranslate"><span class="pre">CSVReader</span></code> class, but we need to manually pass a header as the files do not contain one. The <code class="docutils literal notranslate"><span class="pre">CSVReader</span></code> has a couple of options, we’ll be setting and <code class="docutils literal notranslate"><span class="pre">chunked=False</span></code> to process the data line-by-line and <code class="docutils literal notranslate"><span class="pre">as_dataframe=False</span></code> to process the data as a string rather than DataFrame. See the <span class="xref myst">API Reference</span> for more details</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">nautilus_trader.persistence.external.readers</span> <span class="kn">import</span> <span class="n">CSVReader</span>
<span class="kn">from</span> <span class="nn">nautilus_trader.model.data.tick</span> <span class="kn">import</span> <span class="n">QuoteTick</span>
<span class="kn">from</span> <span class="nn">nautilus_trader.model.objects</span> <span class="kn">import</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">nautilus_trader.core.datetime</span> <span class="kn">import</span> <span class="n">dt_to_unix_nanos</span>

<span class="k">def</span> <span class="nf">parser</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parser function for hist_data FX data, for use with CSV Reader &quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2"> %H%M%S</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">QuoteTick</span><span class="p">(</span>
        <span class="n">instrument_id</span><span class="o">=</span><span class="n">instrument_id</span><span class="p">,</span>
        <span class="n">bid</span><span class="o">=</span><span class="n">Price</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()),</span>
        <span class="n">ask</span><span class="o">=</span><span class="n">Price</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()),</span>
        <span class="n">bid_size</span><span class="o">=</span><span class="n">Quantity</span><span class="o">.</span><span class="n">from_int</span><span class="p">(</span><span class="mi">100_000</span><span class="p">),</span>
        <span class="n">ask_size</span><span class="o">=</span><span class="n">Quantity</span><span class="o">.</span><span class="n">from_int</span><span class="p">(</span><span class="mi">100_000</span><span class="p">),</span>
        <span class="n">ts_event</span><span class="o">=</span><span class="n">dt_to_unix_nanos</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span>
        <span class="n">ts_init</span><span class="o">=</span><span class="n">dt_to_unix_nanos</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-a-datacatalog-if-one-does-not-exist">
<h3>Creating a DataCatalog if one does not exist<a class="headerlink" href="#creating-a-datacatalog-if-one-does-not-exist" title="Permalink to this headline">¶</a></h3>
<p>Now that we have our parser function, we instantiate a <code class="docutils literal notranslate"><span class="pre">DataCatalog</span></code> (passing in a directory where to store the data, by default we will just use the current directory)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="n">CATALOG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/catalog&quot;</span>

<span class="c1"># Clear if it already exists, then create fresh</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CATALOG_PATH</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">CATALOG_PATH</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">CATALOG_PATH</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an instance of the DataCatalog</span>
<span class="kn">from</span> <span class="nn">nautilus_trader.persistence.catalog</span> <span class="kn">import</span> <span class="n">DataCatalog</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">DataCatalog</span><span class="p">(</span><span class="n">CATALOG_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="instruments">
<h3>Instruments<a class="headerlink" href="#instruments" title="Permalink to this headline">¶</a></h3>
<p>Nautilus needs to link market data to an <code class="docutils literal notranslate"><span class="pre">instrument_id</span></code>, and an <code class="docutils literal notranslate"><span class="pre">instrument_id</span></code> to an <code class="docutils literal notranslate"><span class="pre">Instrument</span></code> definition. This can be done at any time, but typically it makes sense to do it when you are loading market data into the catalog.</p>
<p>For our example, Nautilus contains some helpers for creating Forex pairs, which we will use. If, however, you were adding data for financial or crypto markets, you could need to create (and add to the catalog) an instrument corresponding to that instrument_id. Definitions for various other instruments can be found in <code class="docutils literal notranslate"><span class="pre">nautilus_trader.model.instruments</span></code>.</p>
<p>See <a class="reference internal" href="5_instruments.html"><span class="doc std std-doc">Instruments</span></a> for more details on creating other instruments</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nautilus_trader.persistence.external.core</span> <span class="kn">import</span> <span class="n">process_files</span><span class="p">,</span> <span class="n">write_objects</span>
<span class="kn">from</span> <span class="nn">nautilus_trader.backtest.data.providers</span> <span class="kn">import</span> <span class="n">TestInstrumentProvider</span>

<span class="c1"># Use nautilus test helpers to create a EUR/USD Forex instrument for our purposes</span>
<span class="n">instrument</span> <span class="o">=</span> <span class="n">TestInstrumentProvider</span><span class="o">.</span><span class="n">default_fx_ccy</span><span class="p">(</span><span class="s2">&quot;EUR/USD&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can now add our new instrument to the <code class="docutils literal notranslate"><span class="pre">DataCatalog</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nautilus_trader.persistence.external.core</span> <span class="kn">import</span> <span class="n">write_objects</span>

<span class="n">write_objects</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="p">[</span><span class="n">instrument</span><span class="p">])</span>
</pre></div>
</div>
<p>And check its existence:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">catalog</span><span class="o">.</span><span class="n">instruments</span><span class="p">()</span>
</pre></div>
</div>
<!-- #region -->
</div>
<div class="section" id="loading-the-files">
<h3>Loading the files<a class="headerlink" href="#loading-the-files" title="Permalink to this headline">¶</a></h3>
<p>One final note, our parsing function takes an <code class="docutils literal notranslate"><span class="pre">instrument_id</span></code> argument, as in our case with hist_data, the actual file does not contain information about the instrument, only the file name does. In our instance, we would likely need to split our loading per Forex pair, so we can determine which instrument we are loading. We will use a simple lambda function to pass our <code class="docutils literal notranslate"><span class="pre">instrument_id</span></code> to the parsing function.</p>
<p>We can now use the <code class="docutils literal notranslate"><span class="pre">process_files</span></code> function to load one or more files using our <code class="docutils literal notranslate"><span class="pre">Reader</span></code> class and <code class="docutils literal notranslate"><span class="pre">parsing</span></code> function as shown below. This function will loop over many files, as well as breaking up large files into chunks (protecting us from out of memory errors when reading large files) and save the results to the <code class="docutils literal notranslate"><span class="pre">DataCatalog</span></code></p>
<p>For the hist_data, it should take less than a minute or two to load each Forex file (a progress bar will appear below).</p>
<!-- #endregion -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nautilus_trader.persistence.external.core</span> <span class="kn">import</span> <span class="n">process_files</span>

<span class="n">process_files</span><span class="p">(</span>
    <span class="n">glob_path</span><span class="o">=</span><span class="n">input_files</span><span class="p">,</span>
    <span class="n">reader</span><span class="o">=</span><span class="n">CSVReader</span><span class="p">(</span>
        <span class="n">block_parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">parser</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_id</span><span class="o">=</span><span class="n">instrument</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> 
        <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">],</span>
        <span class="n">chunked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">as_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">catalog</span><span class="o">=</span><span class="n">catalog</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-the-data-catalog">
<h2>Using the Data Catalog<a class="headerlink" href="#using-the-data-catalog" title="Permalink to this headline">¶</a></h2>
<p>Once data has been loaded into the catalog, the <code class="docutils literal notranslate"><span class="pre">catalog</span></code> instance can be used for loading data into the backtest engine, or simple for research purposes. It contains various methods to pull data from the catalog, like <code class="docutils literal notranslate"><span class="pre">quote_ticks</span></code> (show below)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">dt_to_unix_nanos</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">))</span>
<span class="n">end</span> <span class="o">=</span>  <span class="n">dt_to_unix_nanos</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-02&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">))</span>

<span class="n">catalog</span><span class="o">.</span><span class="n">quote_ticks</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, clean up the catalog</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CATALOG_PATH</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">CATALOG_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "nautechsystems/nautilus_trader",
            ref: "dev",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./2_user_guide"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Nautech Systems Pty Ltd.<br/>
        
            &copy; Copyright 2015-2022.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>